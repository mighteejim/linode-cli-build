name: embeddings-python
display_name: Embeddings (Python)
version: 0.2.1

description: >
  Sentence-transformers embedding service using Python. Drop-in replacement for TEI
  that avoids Rust hf-hub issues. Works reliably on all platforms.

capabilities:
  runtime: docker

deploy:
  target: linode
  linode:
    image: linode/ubuntu24.04
    region_default: us-southeast
    type_default: g6-standard-2
    tags:
      - ai
      - embeddings
      - python
    
    container:
      image: python:3.11-slim
      internal_port: 80
      external_port: 80
      command: bash /app/start.sh
      volumes:
        - /app:/app
      
      health:
        type: http
        path: /health
        port: 80
        success_codes: [200]
        initial_delay_seconds: 30
        timeout_seconds: 5
        max_retries: 20

setup:
  files:
    - path: /app/main.py
      permissions: "0644"
      content: |
        """Sentence embeddings API using sentence-transformers"""
        from sentence_transformers import SentenceTransformer
        from fastapi import FastAPI
        from pydantic import BaseModel
        from typing import List
        import uvicorn
        import sys
        
        print("Loading model...", file=sys.stderr, flush=True)
        app = FastAPI()
        model = SentenceTransformer("sentence-transformers/all-mpnet-base-v2")
        print("Model loaded!", file=sys.stderr, flush=True)
        
        class EmbedRequest(BaseModel):
            inputs: List[str]
        
        @app.get("/health")
        def health():
            return {"status": "ok"}
        
        @app.post("/embed")
        def embed(req: EmbedRequest):
            return model.encode(req.inputs).tolist()
        
        if __name__ == "__main__":
            uvicorn.run(app, host="0.0.0.0", port=80)
    
    - path: /app/requirements.txt
      permissions: "0644"
      content: |
        # Pin versions for faster/reliable installs
        sentence-transformers==3.3.1
        fastapi==0.115.6
        uvicorn[standard]==0.32.1
    
    - path: /app/start.sh
      permissions: "0755"
      content: |
        #!/bin/bash
        set -e
        echo "=========================================="
        echo "Installing dependencies..."
        echo "=========================================="
        pip install --no-cache-dir -r /app/requirements.txt
        echo ""
        echo "=========================================="
        echo "Starting application..."
        echo "=========================================="
        python /app/main.py

env:
  required: []
  optional:
    - name: HF_TOKEN
      description: Optional Hugging Face token for gated/private models.

guidance:
  summary: |
    Python-based embeddings API compatible with TEI interface.
  examples:
    - description: Health check
      command: curl http://{host}/health
    - description: Generate embeddings
      command: |
        curl -X POST http://{host}/embed \
          -H 'Content-Type: application/json' \
          -d '{"inputs":["Hello from Linode"]}'
